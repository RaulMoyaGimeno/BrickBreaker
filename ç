import { EventEmitter } from "../events/eventEmitter.js";
import { EventListener } from "../events/eventListener.js";
import { EventType } from "../utils/enums.js";
import { BallConfig } from "../utils/types.js";
import { GameObject } from "./gameObject.js";
import { Paddle } from "./paddle.js";

export class Ball extends GameObject implements EventListener {
  private static readonly DEAD = true;
  fire = false;
  radius: number;
  x: number;
  y: number;
  static VELOCIDAD = 5;
  dx: number;
  dy: number;

  constructor(
    private ctx: CanvasRenderingContext2D,
    config: BallConfig,
    x?: number,
    y?: number,
  ) {
    super();
    EventEmitter.getInstance().subscribe(this);
    this.ctx = ctx;
    this.radius = config.radius;
    this.dx = config.dx;
    this.dy = config.dy;
    this.x = x ?? this.ctx.canvas.width / 2;
    this.y = y ?? this.ctx.canvas.height - 80;
  }

  isCollidingWith(other: GameObject): boolean {
    if (other instanceof Paddle) {
      const paddle = other as Paddle;
      const width = paddle.width;

      return (
        this.x > paddle.x &&
        this.x < paddle.x + width &&
        this.y + 1 + this.dy - paddle.y >= 0 &&
        this.y + 1 + this.dy - paddle.y < this.radius + 4
      );
    }
    return false;
  }

  handleCollision(other: GameObject): void {
    if (other instanceof Paddle) {
      console.log("paddle");
      const paddle = other as Paddle;
      let width = paddle.width;
      if (paddle.giant) {
        width *= 1.4;
      }
      const ballX = paddle.x + width - this.x;
      const middle = width / 2;
      const rightSide = ballX < middle;
      let ang: number;

      if (ballX > middle - 10 && ballX < middle + 10) {
        return;
      } else if (rightSide) {
        if (this.dx > 0) {
          ang = 90 + ((middle - ballX) / middle) * 10;
        } else {
          ang = 90 - ((middle - ballX) / middle) * 9;
        }
      } else {
        if (this.dx < 0) {
          ang = 90 + ((middle - ballX) / middle) * 10;
        } else {
          ang = 90 - ((middle - ballX) / middle) * 9;
        }
      }

      this.dx *= ang / 90;
      if ((rightSide && this.dx < 0) || (!rightSide && this.dx > 0)) {
        this.dx *= -1;
      }

      if (this.dx < -5) {
        this.dx = -5;
      }
      if (this.dx > 5) {
        this.dx = 5;
      }

      this.calcularY();
    }
  }

  onEvent(event: EventType): void {
    if (event === EventType.FIREBALL) {
      this.fire = true;
    }
  }

  public draw(): void {
    this.ctx.beginPath();
    this.ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
    this.ctx.fillStyle = this.fire ? "orange" : "white";
    this.ctx.fill();
    this.ctx.closePath();
  }

  public move(): boolean {
    if (
      this.x + this.dx > this.ctx.canvas.width - this.radius ||
      this.x + this.dx < this.radius
    ) {
      this.dx = -this.dx;
    }

    if (this.y + this.dy < this.radius) {
      this.dy = -this.dy;
    }
    if (this.y + this.dy > this.ctx.canvas.height - this.radius) {
      return Ball.DEAD;
    }

    this.x += this.dx;
    this.y += this.dy;
    return !Ball.DEAD;
  }

  calcularY(): void {
    this.dy =
      -1 * Math.sqrt(Math.pow(Ball.VELOCIDAD, 2) - Math.pow(this.dx, 2));
  }

  public changeDirectionY(): void {
    this.dy = -this.dy;
    this.y += this.dy;
  }

  public changeDirectionX(): void {
    this.dx = -this.dx;
    this.x += 2 * this.dx;
  }
}
